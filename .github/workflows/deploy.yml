name: Deploy to RPi

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Raspberry Pi
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Give enough time for tests + deploy

    steps:
      - name: Trigger RPi Deploy Webhook
        id: webhook
        run: |
          # Trigger the deploy webhook
          response=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RPI_DEPLOY_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.RPI_WEBHOOK_URL }}/webhook/deploy")

          # Log the response
          echo "Webhook response:"
          echo "$response"

          # Check if webhook was accepted
          status=$(echo "$response" | jq -r '.status // empty')

          if [ "$status" = "deploying" ]; then
            echo "✓ Deploy started successfully on RPi"
            echo "status=deploying" >> $GITHUB_OUTPUT
          else
            echo "✗ Failed to trigger deploy"
            echo "$response"
            exit 1
          fi

      - name: Wait for Deploy to Complete
        id: wait
        run: |
          # Wait for deploy to complete (max 15 minutes)
          max_attempts=180
          attempt=1

          echo "Waiting for deploy to complete..."

          while [ $attempt -le $max_attempts ]; do
            # Check deploy status
            response=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.RPI_DEPLOY_TOKEN }}" \
              "${{ secrets.RPI_WEBHOOK_URL }}/webhook/status")

            # Get the deploy status from the structured response
            deploy_status=$(echo "$response" | jq -r '.deploy.status // empty')

            # Check for successful completion
            if [ "$deploy_status" = "success" ]; then
              echo "✓ Deploy completed successfully"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Check for failed completion
            if [ "$deploy_status" = "failed" ]; then
              echo "✗ Deploy failed"
              echo "Last deploy logs:"
              echo "$response" | jq -r '.current_deploy_log // "No logs available"' | tail -30
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi

            # If status is "idle", the deploy may not have started yet or already finished
            # Check last_complete timestamp to distinguish
            last_complete=$(echo "$response" | jq -r '.deploy.last_complete // empty')
            last_start=$(echo "$response" | jq -r '.deploy.last_start // empty')

            if [ "$deploy_status" = "idle" ] && [ -n "$last_complete" ] && [ -n "$last_start" ]; then
              # Parse timestamps and check if complete is after start
              # If so, deploy finished but we missed the status transition
              if [ "$last_complete" \> "$last_start" ]; then
                echo "⚠ Deploy finished but status unclear, checking logs..."
                current_log=$(echo "$response" | jq -r '.current_deploy_log // ""')
                if echo "$current_log" | grep -q "Deploy successful"; then
                  echo "✓ Deploy completed successfully (detected from logs)"
                  echo "status=success" >> $GITHUB_OUTPUT
                  exit 0
                fi
              fi
            fi

            echo "Attempt $attempt/$max_attempts: Deploy in progress... (status: $deploy_status)"
            sleep 5
            attempt=$((attempt + 1))
          done

          echo "✗ Deploy timed out"
          echo "Last deploy logs:"
          echo "$response" | jq -r '.current_deploy_log // "No logs available"' | tail -30
          echo "status=timeout" >> $GITHUB_OUTPUT
          exit 1

      - name: Deploy Summary
        if: always()
        run: |
          status="${{ steps.wait.outputs.status }}"
          echo "### Deploy Status: $status" >> $GITHUB_STEP_SUMMARY

          if [ "$status" = "success" ]; then
            echo "✅ Deployment completed successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "$status" = "failed" ]; then
            echo "❌ Deployment failed (check logs on RPi)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⏱️ Deployment timed out" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          # Create GitHub issue on failure
          gh issue create \
            --repo memogarden/memogarden-system \
            --title "Deploy to RPi failed: ${{ github.sha }}" \
            --label "deployment" \
            --body "Deploy failed for commit ${{ github.sha }}.

          **Commit:** ${{ github.sha }}
          **Author:** ${{ github.actor }}
          **Branch:** ${{ github.ref_name }}

          Check RPi logs for details:
          \`\`\`
          ssh rpi 'journalctl -u memogarden-webhook -n 50'
          journalctl -u memogarden-deploy -n 50
          \`\`\`"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
